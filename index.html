<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Inteligente - WhatsApp Integrado</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 img {
            width: 40px;
            height: 40px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.95em;
            border-left: 4px solid #25D366;
            padding-left: 15px;
            background: #f5f5f5;
            border-radius: 0 8px 8px 0;
            line-height: 1.4;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 0.95em;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #25D366;
        }
        .row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .row .form-group {
            flex: 1 1 200px;
        }
        button {
            background: #25D366;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, background 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:hover {
            background: #128C7E;
            transform: scale(1.02);
        }
        .compromissos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 15px;
        }
        .compromissos-header h2 {
            color: #333;
            font-size: 1.4em;
        }
        .badge {
            background: #25D366;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .lista-compromissos {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            background: #f9f9f9;
            padding: 5px;
        }
        .compromisso-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 5px solid #25D366;
            transition: all 0.2s;
            position: relative;
        }
        .compromisso-item.alerta {
            border-left-color: #ff4444;
            background: #fff5f5;
        }
        .compromisso-item .titulo {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            padding-right: 60px;
        }
        .compromisso-item .descricao {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        .compromisso-item .data-hora {
            color: #25D366;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .compromisso-item .alertas {
            margin-top: 8px;
            font-size: 0.8em;
            color: #ff4444;
            background: #ffeeee;
            padding: 4px 8px;
            border-radius: 20px;
            display: inline-block;
        }
        .btn-remover {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .btn-remover:hover {
            background: #cc0000;
        }
        .vazio {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }
        .whatsapp-hint {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.95em;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid #25D366;
        }
        .whatsapp-hint i {
            font-size: 2em;
        }
        .numero-fixo {
            background: #25D366;
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block;
        }
        .teste-alerta {
            background: #128C7E;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
        .teste-alerta:hover {
            background: #075E54;
        }
        footer {
            margin-top: 20px;
            text-align: center;
            color: #aaa;
            font-size: 0.8em;
        }
        .mensagem-status {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png" alt="WhatsApp">
            Agenda com Alerta WhatsApp
        </h1>
        <div class="subtitle">
            ‚è∞ Seus compromissos te avisam automaticamente 24h, 2h e 1h antes via WhatsApp
        </div>

        <div class="whatsapp-hint">
            <span>üì±</span>
            <div>
                <strong>WhatsApp configurado:</strong> 
                <div class="numero-fixo">+55 12 98846-1978</div>
                <small style="display: block; margin-top: 5px;">Todos os alertas ser√£o enviados para este n√∫mero</small>
            </div>
        </div>

        <!-- Bot√£o de teste r√°pido -->
        <button class="teste-alerta" onclick="testarWhatsApp()">
            üì± TESTAR WHATSAPP - Enviar mensagem agora
        </button>

        <div id="mensagemStatus" class="mensagem-status"></div>

        <form id="formCompromisso">
            <div class="form-group">
                <label>T√≠tulo do Compromisso *</label>
                <input type="text" id="titulo" placeholder="Ex: Reuni√£o com cliente" required>
            </div>
            <div class="form-group">
                <label>Descri√ß√£o (opcional)</label>
                <textarea id="descricao" rows="2" placeholder="Detalhes importantes..."></textarea>
            </div>
            <div class="row">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="data" required>
                </div>
                <div class="form-group">
                    <label>Hora *</label>
                    <input type="time" id="hora" required>
                </div>
            </div>
            
            <!-- Campo WhatsApp oculto com o n√∫mero fixo -->
            <input type="hidden" id="whatsapp" value="5512988461978">
            
            <button type="submit">
                <span>‚ûï</span> Agendar Compromisso
            </button>
        </form>

        <div class="compromissos-header">
            <h2>üìÖ Pr√≥ximos Compromissos</h2>
            <span class="badge" id="contador">0</span>
        </div>

        <ul class="lista-compromissos" id="listaCompromissos">
            <li class="vazio">Nenhum compromisso agendado ainda.</li>
        </ul>

        <footer>
            ‚è±Ô∏è Alertas autom√°ticos: 24h, 2h e 1h antes do evento ‚Ä¢ WhatsApp: 12 98846-1978
        </footer>
    </div>

    <script>
        // N√∫mero fixo do WhatsApp (formatado: 55 + DDD + n√∫mero)
        const WHATSAPP_FIXO = '5512988461978';
        
        // Carregar compromissos salvos
        let compromissos = JSON.parse(localStorage.getItem('compromissos')) || [];

        // Elementos do DOM
        const form = document.getElementById('formCompromisso');
        const lista = document.getElementById('listaCompromissos');
        const contador = document.getElementById('contador');
        const dataInput = document.getElementById('data');
        const horaInput = document.getElementById('hora');
        const tituloInput = document.getElementById('titulo');
        const descricaoInput = document.getElementById('descricao');
        const mensagemStatus = document.getElementById('mensagemStatus');

        // Configurar data m√≠nima (hoje)
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        dataInput.min = `${ano}-${mes}-${dia}`;

        // Fun√ß√£o para mostrar mensagem de status
        function mostrarStatus(mensagem, isErro = false) {
            mensagemStatus.style.display = 'block';
            mensagemStatus.textContent = mensagem;
            mensagemStatus.style.background = isErro ? '#f8d7da' : '#fff3cd';
            mensagemStatus.style.color = isErro ? '#721c24' : '#856404';
            
            setTimeout(() => {
                mensagemStatus.style.display = 'none';
            }, 5000);
        }

        // Fun√ß√£o para testar WhatsApp
        window.testarWhatsApp = function() {
            const mensagemTeste = encodeURIComponent(
                `üîî *TESTE DE ALERTA* üîî\n\n` +
                `Esta √© uma mensagem de teste da sua Agenda Inteligente.\n\n` +
                `‚úÖ Se voc√™ recebeu esta mensagem, o WhatsApp est√° funcionando corretamente!\n\n` +
                `‚è∞ Os alertas autom√°ticos ser√£o enviados 24h, 2h e 1h antes dos seus compromissos.`
            );
            
            const url = `https://wa.me/${WHATSAPP_FIXO}?text=${mensagemTeste}`;
            
            // Tenta abrir em uma nova aba
            const novaJanela = window.open(url, '_blank');
            
            if (!novaJanela || novaJanela.closed || typeof novaJanela.closed == 'undefined') {
                // Se o pop-up foi bloqueado, mostra instru√ß√µes
                mostrarStatus('‚ö†Ô∏è Pop-up bloqueado! Clique no link que aparecer√° abaixo.', true);
                
                // Cria um link clic√°vel
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.textContent = 'üì± Clique aqui para abrir o WhatsApp';
                link.style.display = 'block';
                link.style.padding = '10px';
                link.style.background = '#25D366';
                link.style.color = 'white';
                link.style.textAlign = 'center';
                link.style.borderRadius = '5px';
                link.style.marginTop = '10px';
                link.style.textDecoration = 'none';
                
                mensagemStatus.innerHTML = '';
                mensagemStatus.appendChild(link);
                mensagemStatus.style.display = 'block';
            } else {
                mostrarStatus('‚úÖ WhatsApp aberto com sucesso!');
            }
        };

        // Formatar data para exibi√ß√£o
        function formatarData(dataStr) {
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Verificar alertas e retornar quais est√£o ativos
        function verificarAlertas(dataHoraCompromisso) {
            const agora = new Date();
            const compromissoDate = new Date(dataHoraCompromisso);
            const diffMs = compromissoDate - agora;
            const diffHoras = diffMs / (1000 * 60 * 60);
            
            const alertas = [];
            if (diffHoras <= 24 && diffHoras > 23.9) alertas.push('‚è∞ 24h');
            if (diffHoras <= 2 && diffHoras > 1.9) alertas.push('‚è∞ 2h');
            if (diffHoras <= 1 && diffHoras > 0.9) alertas.push('‚è∞ 1h');
            if (diffHoras <= 0.1 && diffHoras > 0) alertas.push('üîî J√° est√° acontecendo!');
            
            return alertas;
        }

        // Gerar mensagem para WhatsApp
        function gerarMensagemWhatsApp(compromisso, tipoAlerta) {
            const dataFormatada = formatarData(compromisso.data);
            const titulo = compromisso.titulo;
            const descricao = compromisso.descricao || 'Sem descri√ß√£o';
            
            let mensagem = '';
            if (tipoAlerta === '24h') {
                mensagem = `üîî *LEMBRETE: FALTA 24 HORAS* üîî\n\nCompromisso: ${titulo}\nData: ${dataFormatada}\nHora: ${compromisso.hora}\nDescri√ß√£o: ${descricao}\n\nVoc√™ tem 24 horas at√© este evento. J√° se prepare!`;
            } else if (tipoAlerta === '2h') {
                mensagem = `‚ö†Ô∏è *ALERTA: FALTAM 2 HORAS* ‚ö†Ô∏è\n\nCompromisso: ${titulo}\nData: ${dataFormatada}\nHora: ${compromisso.hora}\nDescri√ß√£o: ${descricao}\n\nFaltam apenas 2 horas!`;
            } else if (tipoAlerta === '1h') {
                mensagem = `üö® *√öLTIMA HORA: FALTA 1 HORA* üö®\n\nCompromisso: ${titulo}\nData: ${dataFormatada}\nHora: ${compromisso.hora}\nDescri√ß√£o: ${descricao}\n\nCorre, falta 1 hora!`;
            } else {
                mensagem = `üìÖ *COMPROMISSO AGENDADO* üìÖ\n\nT√≠tulo: ${titulo}\nData: ${dataFormatada}\nHora: ${compromisso.hora}\nDescri√ß√£o: ${descricao}`;
            }
            
            return encodeURIComponent(mensagem);
        }

        // Abrir WhatsApp com mensagem (sempre usando o n√∫mero fixo)
        function abrirWhatsApp(mensagem) {
            const url = `https://wa.me/${WHATSAPP_FIXO}?text=${mensagem}`;
            
            // Tenta abrir em uma nova aba
            const novaJanela = window.open(url, '_blank');
            
            if (!novaJanela || novaJanela.closed || typeof novaJanela.closed == 'undefined') {
                // Se o pop-up foi bloqueado, mostra um link
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.textContent = 'üì± Clique aqui para enviar a mensagem no WhatsApp';
                link.style.display = 'block';
                link.style.padding = '10px';
                link.style.background = '#25D366';
                link.style.color = 'white';
                link.style.textAlign = 'center';
                link.style.borderRadius = '5px';
                link.style.marginTop = '10px';
                link.style.textDecoration = 'none';
                
                mensagemStatus.innerHTML = '';
                mensagemStatus.appendChild(link);
                mensagemStatus.style.display = 'block';
                
                mostrarStatus('‚ö†Ô∏è Pop-up bloqueado! Use o link abaixo:', true);
            }
        }

        // Renderizar lista de compromissos
        function renderizarLista() {
            if (compromissos.length === 0) {
                lista.innerHTML = '<li class="vazio">Nenhum compromisso agendado ainda.</li>';
                contador.textContent = '0';
                return;
            }

            // Ordenar por data/hora (mais pr√≥ximo primeiro)
            compromissos.sort((a, b) => {
                const dataA = new Date(`${a.data}T${a.hora}`);
                const dataB = new Date(`${b.data}T${b.hora}`);
                return dataA - dataB;
            });

            let html = '';
            compromissos.forEach((comp, index) => {
                const dataHoraStr = `${comp.data}T${comp.hora}`;
                const alertasAtivos = verificarAlertas(dataHoraStr);
                const temAlerta = alertasAtivos.length > 0;
                
                html += `
                    <li class="compromisso-item ${temAlerta ? 'alerta' : ''}" data-index="${index}">
                        <button class="btn-remover" onclick="removerCompromisso(${index})" title="Remover compromisso">√ó</button>
                        <div class="titulo">${comp.titulo}</div>
                        ${comp.descricao ? `<div class="descricao">${comp.descricao}</div>` : ''}
                        <div class="data-hora">
                            <span>üìÖ ${formatarData(comp.data)}</span>
                            <span>‚è∞ ${comp.hora}</span>
                        </div>
                        ${temAlerta ? `<div class="alertas">üîî Alerta agora: ${alertasAtivos.join(', ')}</div>` : ''}
                        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="enviarAlertaManual(${index}, '24h')" style="background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer;">‚è∞ 24h</button>
                            <button onclick="enviarAlertaManual(${index}, '2h')" style="background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer;">‚è∞ 2h</button>
                            <button onclick="enviarAlertaManual(${index}, '1h')" style="background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer;">‚è∞ 1h</button>
                            <button onclick="enviarDetalhes(${index})" style="background: #128C7E; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer;">üì≤ Detalhes</button>
                        </div>
                    </li>
                `;
            });

            lista.innerHTML = html;
            contador.textContent = compromissos.length;
        }

        // Verificar todos os compromissos e disparar alertas se necess√°rio
        function verificarTodosAlertas() {
            const agora = new Date();
            let precisaRenderizar = false;
            
            compromissos.forEach((comp, index) => {
                const dataHoraComp = new Date(`${comp.data}T${comp.hora}`);
                const diffMs = dataHoraComp - agora;
                const diffHoras = diffMs / (1000 * 60 * 60);
                
                // Evita alertas repetidos (simples controle)
                if (diffHoras <= 24 && diffHoras > 23.9 && !comp.alerta24h) {
                    enviarAlertaManual(index, '24h');
                    comp.alerta24h = true;
                    precisaRenderizar = true;
                }
                if (diffHoras <= 2 && diffHoras > 1.9 && !comp.alerta2h) {
                    enviarAlertaManual(index, '2h');
                    comp.alerta2h = true;
                    precisaRenderizar = true;
                }
                if (diffHoras <= 1 && diffHoras > 0.9 && !comp.alerta1h) {
                    enviarAlertaManual(index, '1h');
                    comp.alerta1h = true;
                    precisaRenderizar = true;
                }
            });
            
            if (precisaRenderizar) {
                localStorage.setItem('compromissos', JSON.stringify(compromissos));
                renderizarLista();
            }
        }

        // Fun√ß√µes globais para bot√µes
        window.enviarAlertaManual = function(index, tipo) {
            const comp = compromissos[index];
            if (!comp) return;
            
            const mensagem = gerarMensagemWhatsApp(comp, tipo);
            abrirWhatsApp(mensagem);
        };

        window.enviarDetalhes = function(index) {
            const comp = compromissos[index];
            if (!comp) return;
            
            const mensagem = gerarMensagemWhatsApp(comp, '');
            abrirWhatsApp(mensagem);
        };

        window.removerCompromisso = function(index) {
            if (confirm('Remover este compromisso?')) {
                compromissos.splice(index, 1);
                localStorage.setItem('compromissos', JSON.stringify(compromissos));
                renderizarLista();
            }
        };

        // Adicionar novo compromisso
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const titulo = tituloInput.value.trim();
            const descricao = descricaoInput.value.trim();
            const data = dataInput.value;
            const hora = horaInput.value;

            if (!titulo || !data || !hora) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Validar data futura
            const dataHoraEscolhida = new Date(`${data}T${hora}`);
            if (dataHoraEscolhida < new Date()) {
                alert('A data/hora do compromisso deve ser futura.');
                return;
            }

            const novoCompromisso = {
                titulo,
                descricao,
                data,
                hora,
                whatsapp: WHATSAPP_FIXO,
                alerta24h: false,
                alerta2h: false,
                alerta1h: false,
                criado: new Date().toISOString()
            };

            compromissos.push(novoCompromisso);
            localStorage.setItem('compromissos', JSON.stringify(compromissos));

            // Limpar formul√°rio
            tituloInput.value = '';
            descricaoInput.value = '';
            dataInput.value = '';
            horaInput.value = '';

            renderizarLista();
            
            // Mostrar mensagem de sucesso
            mostrarStatus('‚úÖ Compromisso agendado com sucesso!');
            
            // Verificar se j√° existe alerta para este compromisso
            setTimeout(() => verificarTodosAlertas(), 1000);
        });

        // Inicializar lista e verificar alertas
        renderizarLista();
        verificarTodosAlertas();

        // Verificar alertas a cada 30 segundos
        setInterval(verificarTodosAlertas, 30000);
    </script>
</body>
</html>
